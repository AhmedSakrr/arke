---
kind: pipeline
name: default

steps:
  - name: Configure Vault
    image: vault:0.11.4
    commands:
      - vault secrets disable secret
      - vault secrets enable -path=secret -version=1 kv
    environment:
      VAULT_TOKEN: changeme
      VAULT_DEV_ROOT_TOKEN_ID: changeme
      VAULT_ADDR: http://vault:8200

  - name: Run rspec
    image: ruby:2.6.3
    environment:
      DATABASE_HOST: database
      RAILS_ENV: test
      VAULT_ADDR: http://vault:8200
    commands:
      - gem update bundler
      - bundle --jobs $(nproc)
      - bundle exec rake db:drop db:create db:migrate
      - bundle exec rspec

services:
- name: database
  image: mariadb
  ports:
    - 3306
  environment:
    MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
- name: vault
  image: vault:0.11.4
  ports:
    - 8200
  environment:
    SKIP_SETCAP: 1
    VAULT_TOKEN: changeme
    VAULT_DEV_ROOT_TOKEN_ID: changeme
    VAULT_ADDR: http://vault:8200

trigger:
  event:
    - push
